<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>商品購入</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="page-container">

    <h2>商品購入</h2>

    <form th:action="@{/purchase/confirm}"
          method="post"
          class="purchase-form">

        <!-- 商品ID（隐藏提交） -->
        <input type="hidden" name="productId" th:value="${product.pId}">

        <div class="form-group">
            <label>商品ID：</label>
            <span th:text="${product.pId}"></span>
        </div>

        <div class="form-group">
            <label>商品名：</label>
            <span th:text="${product.pName}"></span>
        </div>

        <div class="form-group">
            <label>単価：</label>
            <span th:text="${product.price}"></span> 円
        </div>

        <div class="form-group">
            <label>担当者：</label>
            <span th:text="${staff.id}"></span>
        </div>

        <!-- ★ 顾客ID（即时校验） -->
        <div class="form-group">
            <label>顧客ID：</label>
            <input type="number"
                   id="customerId"
                   name="customerId"
                   required
                   onblur="checkCustomer()">

            <p id="customerMessage"></p>
        </div>

        <div class="form-group">
            <label>購入数量：</label>
            <input type="number"
                   name="quantity"
                   min="1"
                   required>
        </div>

        <button type="submit"
                id="submitBtn"
                class="btn-primary">
            確認へ
        </button>

    </form>

    <p class="back-link">
        <a th:href="@{/production}">商品一覧へ戻る</a>
    </p>

</div>

<!-- ★ JavaScript 校验 -->
<script>
function checkCustomer() {
    const customerIdInput = document.getElementById("customerId");
    const customerId = customerIdInput.value;
    const msg = document.getElementById("customerMessage");
    const btn = document.getElementById("submitBtn");

    // === 初始化状态（关键）===
    msg.textContent = "";
    msg.style.color = "";
    btn.disabled = true;

    if (!customerId) {
        return;
    }

    fetch(`/purchase/checkCustomer?customerId=${customerId}`)
        .then(res => res.json())
        .then(data => {
            if (data.exists === true) {
                msg.textContent = "顧客名：" + data.name;
                msg.style.color = "green";
                btn.disabled = false;   // ★ 明确解锁
            } else {
                msg.textContent = "該当する顧客が存在しません。";
                msg.style.color = "red";
                btn.disabled = true;
            }
        })
        .catch(() => {
            msg.textContent = "顧客情報の確認に失敗しました。";
            msg.style.color = "red";
            btn.disabled = true;
        });
}
</script>

</body>
</html>
